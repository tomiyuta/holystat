# 包括的ロバスト性評価スクリプト v2

## 概要

市場環境適応型ポートフォリオ戦略のロバスト性を包括的に評価するスクリプトです。14種類の統計的検証テストを実施し、戦略の信頼性を多角的に分析します。過剰最適化（オーバーフィッティング）のリスクを定量的に評価し、実運用における期待パフォーマンスを推定します。

## 入出力

| 項目 | ファイル名 | 説明 |
|------|-----------|------|
| 入力 | `holygrail.parquet` | S&P500構成銘柄およびETFの日次価格データ |
| 出力 | `robust.json` | ロバスト性評価結果（14テストの結果、総合評価） |

## テスト一覧（14テスト）

### 必須テスト（3テスト）

| # | テスト名 | 説明 |
|---|----------|------|
| 1 | 取引コスト感度分析 | 0.1%/0.2%/0.5%/1.0%のコストでSharpe変化を検証 |
| 2 | レジーム別パフォーマンス分解 | GFC/低金利期/コロナ/インフレ期/直近の5期間で分析 |
| 3 | テールリスク分析 | CVaR(5%)、最悪12ヶ月、ドローダウン滞在期間 |

### 推奨テスト（3テスト）

| # | テスト名 | 説明 |
|---|----------|------|
| 4 | パラメータ感度分析 | モメンタム期間(3/6/12M) × 銘柄数(3/5/10)の9パターン |
| 5 | ブロックブートストラップ | Sharpe/MaxDDの95%信頼区間を1000回サンプリングで推定 |
| 6 | DSR/PSR計算 | 歪度・尖度を考慮した統計的有意性（Deflated Sharpe Ratio） |

### 任意テスト（3テスト）

| # | テスト名 | 説明 |
|---|----------|------|
| 7 | サバイバーシップバイアス補正 | -2%pt/年のペナルティを適用した補正後パフォーマンス |
| 8 | レバレッジ分析 | レバレッジ>1の頻度と資金調達コストの影響 |
| 9 | リバランス日感度 | 月初/月中/月末のタイミングによる影響を検証 |

### 追加テスト v2（5テスト）

| # | テスト名 | 説明 |
|---|----------|------|
| 10 | モンテカルロ順列検定 | 1000回シャッフルでp値を算出し、偶然性を排除 |
| 11 | Cohen's d | 効果量の大きさを評価（0.8以上で大きな効果） |
| 12 | Bonferroni補正 | 多重比較による偽陽性を補正（α/n） |
| 13 | PBO（過剰最適化リスク） | CSCV法で過剰フィッティングを検出 |
| 14 | WFA一貫性 | Walk-Forward分析での安定性を評価 |

## パラメータ設定

### 基本パラメータ

| パラメータ | 値 | 説明 |
|-----------|-----|------|
| MOMENTUM_PERIOD | 126日 | モメンタム計算期間（デフォルト） |
| MA_PERIOD | 200日 | 移動平均期間 |
| REGIME_THRESHOLD | 0.95 | レジーム判定閾値 |
| ATTACK_TOP_N | 5 | 攻撃型戦略の銘柄数 |
| DEFENSE_TOP_N_3 | 3 | 防御型TOP3の銘柄数 |

### ボラティリティ推定パラメータ

| パラメータ | 値 | 説明 |
|-----------|-----|------|
| VOL_SHORT_PERIOD | 21日 | 短期ボラティリティ期間 |
| VOL_LONG_PERIOD | 60日 | 長期ボラティリティ期間 |
| VOL_SHORT_WEIGHT | 0.7 | 短期Volの重み |
| VOL_LONG_WEIGHT | 0.3 | 長期Volの重み |
| VOL_FLOOR | 5% | ボラティリティフロア |
| WEIGHT_CAP | 40% | 単一銘柄ウェイト上限 |

### VolScaleパラメータ

| パラメータ | 値 | 説明 |
|-----------|-----|------|
| VOLSCALE_LOOKBACK | 21日 | スケーリング計算期間 |
| VOLSCALE_MIN | 0.5 | 最小スケール |
| VOLSCALE_MAX | 1.5 | 最大スケール |
| TRANSACTION_COST | 0.2% | 往復取引コスト（デフォルト） |

## 使用方法

```bash
$ python robust.py
```

実行後、`robust.json`が生成されます。

## 依存ライブラリ

- numpy
- pandas
- scipy
- json

## 出力フォーマット

`robust.json`には以下の情報が含まれます。

```json
{
  "metadata": {
    "version": "v2.0",
    "generated_at": "2025-01-23T...",
    "data_period": "2004-01 〜 2025-12"
  },
  "robustness_tests": {
    "test1_transaction_cost": {
      "D2": {
        "cost_0.1%": { "sharpe": 0.92 },
        "cost_0.2%": { "sharpe": 0.85 },
        "cost_0.5%": { "sharpe": 0.71 },
        "cost_1.0%": { "sharpe": 0.52 }
      },
      ...
    },
    "test2_regime_breakdown": { ... },
    "test3_tail_risk": { ... },
    ...
    "test14_wfa_consistency": { ... }
  },
  "comprehensive_evaluation": {
    "D2": {
      "robustness_score": 72.5,
      "grade": "B+",
      "strengths": ["高いSharpe比", "モンテカルロ検定合格"],
      "weaknesses": ["テールリスクが高い", "PBOリスクあり"]
    },
    ...
  }
}
```

## 各テストの詳細

### テスト1: 取引コスト感度分析

取引コストが戦略パフォーマンスに与える影響を定量化します。コストが0.1%から1.0%に増加した場合のSharpe比の低下率を計算し、コスト耐性を評価します。

**評価基準**: Sharpe低下率が20%未満であれば「コスト耐性あり」と判定

### テスト2: レジーム別パフォーマンス分解

以下の5つの市場環境期間でパフォーマンスを分解分析します。

| 期間 | 開始 | 終了 | 特徴 |
|------|------|------|------|
| GFC（金融危機） | 2007-10 | 2009-03 | 急激な下落と回復 |
| 低金利期 | 2009-04 | 2020-02 | 長期上昇トレンド |
| コロナショック | 2020-03 | 2020-12 | 急落と急回復 |
| インフレ期 | 2021-01 | 2023-12 | 金利上昇局面 |
| 直近 | 2024-01 | 現在 | 最新の市場環境 |

### テスト3: テールリスク分析

極端な市場環境下でのリスクを評価します。

| 指標 | 説明 |
|------|------|
| CVaR(5%) | 最悪5%のケースの平均損失 |
| 最悪12ヶ月 | 12ヶ月ローリングリターンの最小値 |
| DD滞在期間 | ドローダウンからの回復に要した最長期間 |

### テスト5: ブロックブートストラップ

月次リターンをブロック単位（3ヶ月）でリサンプリングし、1000回のシミュレーションでSharpe比とMaxDDの95%信頼区間を推定します。

### テスト6: DSR/PSR計算

Deflated Sharpe Ratio（DSR）は、歪度と尖度を考慮したSharpe比の統計的有意性を評価します。

> DSR = (Sharpe - γ) / σ(Sharpe)
> 
> ここで γ は歪度・尖度による補正項

### テスト10: モンテカルロ順列検定

リターン系列をランダムにシャッフルし、1000回のシミュレーションでp値を算出します。p値が0.05未満であれば、戦略のパフォーマンスが偶然ではないことを示します。

### テスト13: PBO（Probability of Backtest Overfitting）

CSCV（Combinatorially Symmetric Cross-Validation）法を用いて、バックテストの過剰最適化リスクを評価します。

**評価基準**: PBO < 0.5 であれば「過剰最適化リスク低」と判定

## 総合評価グレード

各戦略は14テストの結果を総合し、以下のグレードで評価されます。

| グレード | スコア範囲 | 説明 |
|----------|-----------|------|
| A+ | 90-100 | 極めて高いロバスト性 |
| A | 80-89 | 高いロバスト性 |
| B+ | 70-79 | 良好なロバスト性 |
| B | 60-69 | 標準的なロバスト性 |
| C | 50-59 | やや低いロバスト性 |
| D | 50未満 | 低いロバスト性 |

## 制限事項

1. **計算時間**: 全14テストの実行には約10-15分を要します。特にモンテカルロ検定とブートストラップは計算負荷が高いです。

2. **データ依存性**: 評価結果はデータ期間に依存します。異なる期間では結果が変わる可能性があります。

3. **パラメータ選択**: 一部のテスト（PBO、WFA）のパラメータは経験的に設定されており、最適値ではない可能性があります。

4. **相関の無視**: 各テストは独立に実施されており、テスト間の相関は考慮されていません。

---

**作成者**: Portfolio Advisor System  
**バージョン**: v2.0  
**最終更新**: 2025-01-23
