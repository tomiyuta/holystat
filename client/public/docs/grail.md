# Holy Grail シミュレーション v4

## 概要

市場環境適応型ポートフォリオ戦略のバックテストシミュレーションエンジンです。S&P100/500のモメンタム戦略と防御型ETF戦略を組み合わせ、レジームスイッチングとボラティリティスケーリングを適用することで、リスク調整後リターンの最大化を目指します。

## 入出力

| 項目 | ファイル名 | 説明 |
|------|-----------|------|
| 入力 | `holygrail.parquet` | S&P500構成銘柄およびETFの日次価格データ（2004年～） |
| 出力 | `grail.json` | シミュレーション結果（指標、月次リターン、累積リターン系列） |

## v4変更点

本バージョンでは以下の改善を実施しました。

1. **取引コストの織り込み**: 往復0.2%（片道0.1%）の取引コストをシミュレーションに反映
2. **サバイバーシップ・バイアス補正**: 年率-2%のペナルティを適用し、過大評価を抑制
3. **ボラティリティ推定の改善**: 短期Vol（21日）と長期Vol（60日）の加重平均を採用し、5%のフロアを設定

## 戦略一覧（13戦略）

### 通常版（7戦略）

| # | 戦略名 | 説明 |
|---|--------|------|
| 1 | D2 | S&P100モメンタムTop5、リスク逆数ウェイト |
| 2 | D3 | S&P500モメンタムTop5、リスク逆数ウェイト |
| 3 | 防御型TOP5 | 13種ETFからモメンタムTop5 |
| 4 | 防御型TOP3 | 13種ETFからモメンタムTop3 |
| 5 | D2+防御型 | Bull時D2、Bear時防御型Top3にスイッチ |
| 6 | D3+防御型 | Bull時D3、Bear時防御型Top3にスイッチ |
| 7 | SPY | ベンチマーク（バイ＆ホールド） |

### VolScale版（6戦略）

| # | 戦略名 | 説明 |
|---|--------|------|
| 8 | D2_VolScale | D2 + 目標Vol 19% |
| 9 | D3_VolScale | D3 + 目標Vol 19% |
| 10 | 防御型TOP5_VolScale | 防御型TOP5 + 目標Vol 8% |
| 11 | 防御型TOP3_VolScale | 防御型TOP3 + 目標Vol 8% |
| 12 | D2+防御型_VolScale | D2+防御型 + 目標Vol 11% |
| 13 | D3+防御型_VolScale | D3+防御型 + 目標Vol 14% |

## レジーム判定ルール

市場環境の判定には、SPYの200日移動平均線を基準とした以下のルールを適用します。

| レジーム | 条件 |
|----------|------|
| Bull（強気） | SPY終値 > MA200 × 0.95 |
| Bear（弱気） | SPY終値 ≤ MA200 × 0.95 |

## パラメータ設定

### 基本パラメータ

| パラメータ | 値 | 説明 |
|-----------|-----|------|
| MOMENTUM_PERIOD | 126日 | モメンタム計算期間（約6ヶ月） |
| MA_PERIOD | 200日 | 移動平均期間 |
| REGIME_THRESHOLD | 0.95 | レジーム判定閾値 |
| ATTACK_TOP_N | 5 | 攻撃型戦略の銘柄数 |
| DEFENSE_TOP_N_5 | 5 | 防御型TOP5の銘柄数 |
| DEFENSE_TOP_N_3 | 3 | 防御型TOP3の銘柄数 |

### ボラティリティ推定パラメータ

| パラメータ | 値 | 説明 |
|-----------|-----|------|
| VOL_SHORT_PERIOD | 21日 | 短期ボラティリティ期間 |
| VOL_LONG_PERIOD | 60日 | 長期ボラティリティ期間 |
| VOL_SHORT_WEIGHT | 0.7 | 短期Volの重み（急変への追随性重視） |
| VOL_LONG_WEIGHT | 0.3 | 長期Volの重み |
| VOL_FLOOR | 5% | ボラティリティフロア |
| WEIGHT_CAP | 40% | 単一銘柄ウェイト上限 |

### VolScaleパラメータ

| パラメータ | 値 | 説明 |
|-----------|-----|------|
| VOLSCALE_LOOKBACK | 21日 | スケーリング計算期間 |
| VOLSCALE_MIN | 0.5 | 最小スケール |
| VOLSCALE_MAX | 1.5 | 最大スケール |
| TRANSACTION_COST | 0.2% | 往復取引コスト |

### 戦略別目標ボラティリティ

| 戦略 | 目標Vol |
|------|---------|
| D2 | 19% |
| D3 | 19% |
| 防御型TOP5 | 8% |
| 防御型TOP3 | 8% |
| D2+防御型 | 11% |
| D3+防御型 | 14% |

## 使用方法

```bash
$ python grail.py
```

実行後、`grail.json`が生成されます。

## 依存ライブラリ

- numpy
- pandas
- json

## 出力フォーマット

`grail.json`には以下の情報が含まれます。

```json
{
  "metadata": {
    "version": "v4.0",
    "generated_at": "2025-01-23T...",
    "data_period": "2004-01 〜 2025-12"
  },
  "strategies": {
    "D2": {
      "cagr": 19.1,
      "max_dd": -42.7,
      "sharpe": 0.85,
      "sortino": 1.52,
      "calmar": 0.45,
      "monthly_returns": [...],
      "cumulative_returns": [...]
    },
    ...
  }
}
```

## 制限事項

1. **サバイバーシップ・バイアス**: 現在のS&P500構成銘柄で過去をバックテストしているため、倒産・除外銘柄が含まれず、リターンが過大評価される可能性があります。年率-2%の補正を適用していますが、完全な補正ではありません。

2. **取引コスト**: 往復0.2%を想定していますが、実際のスリッページや流動性コストは考慮されていません。

3. **データ品質**: 株式分割・配当調整済み価格を使用していますが、一部銘柄でデータ欠損がある可能性があります。

---

**作成者**: Portfolio Advisor System  
**バージョン**: v4.0  
**最終更新**: 2025-01-23
